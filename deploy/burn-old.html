<!DOCTYPE HTML>
<html>
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
        <title>Rally Burn Chart Prototype</title>
        
        <!-- HighCharts -->
        <script type="text/javascript" src="https://people.rallydev.com/js/jquery.min.js"></script>
        <script type="text/javascript" src="https://people.rallydev.com/js/highcharts.js"></script>
        <script type="text/javascript" src="https://people.rallydev.com/js/exporting.js"></script>
        <!-- a theme file
            <script type="text/javascript" src="../js/themes/gray.js"></script>
        -->
        
        <!-- Lumenize -->
        <script type="text/javascript" src="https://raw.github.com/lmaccherone/Lumenize/master/deploy/Lumenize.js"></script>
        
        <!-- rally_analytics -->
        
<script type="text/javascript">
(function(){var t,e,r,i,s,o,n,a,l,h=function(t,e){return function(){return t.apply(e,arguments)}},u={}.hasOwnProperty,c=function(t,e){function r(){this.constructor=t}for(var i in e)u.call(e,i)&&(t[i]=e[i]);return r.prototype=e.prototype,t.prototype=new r,t.__super__=e.prototype,t},p=[].indexOf||function(t){for(var e=0,r=this.length;r>e;e++)if(e in this&&this[e]===t)return e;return-1};l=this,a=function(){var t,e,r,i,s;for(t={},s="Boolean Number String Function Array Date RegExp Undefined Null".split(" "),r=0,i=s.length;i>r;r++)e=s[r],t["[object "+e+"]"]=e.toLowerCase();return function(e){var r;return r=Object.prototype.toString.call(e),t[r]||"object"}}(),t=function(){function t(t,e){var r,i,s,o,n,a,u,c,p,f;this.upToDate=e,this._gotResponse=h(this._gotResponse,this),this._debug=!1,"undefined"==typeof process||null===process||"undefined"!=typeof window&&null!==window?null!=l.XMLHttpRequest&&(r=l.XMLHttpRequest):r=require("xmlhttprequest").XMLHttpRequest,this.XHRClass=r,this._xhr=null,this._find=null,this._fields=[],this._sort={_ValidFrom:1},this._startIndex=0,this._pageSize=1e5,this._callback=null,this.headers={},this.headers["X-RallyIntegrationLibrary"]="rally_analytics-0.1.0","undefined"!=typeof navigator&&null!==navigator?(n=navigator.appName+" "+navigator.appVersion,o=navigator.platform):"undefined"!=typeof process&&null!==process&&(n="Node.js (or some other non-browser) "+process.version,o=process.platform),this.headers["X-RallyIntegrationPlatform"]=n,this.headers["X-RallyIntegrationOS"]=o,u=t.additionalHeaders;for(s in u)a=u[s],this.headers[s]=a;if(i=function(e,r){if(null!=t[r])return e[r]=t[r];throw Error("Must include config["+r+"] header when instantiating this rally_analytics.AnalyticsQuery object")},i(this.headers,"X-RallyIntegrationName"),i(this.headers,"X-RallyIntegrationVendor"),i(this.headers,"X-RallyIntegrationVersion"),null!=t.workspaceOID)this.workspaceOID=t.workspaceOID;else{if(!("undefined"!=typeof process&&null!==process?null!=(c=process.env)?c.RALLY_WORKSPACE:void 0:void 0))throw Error("Must provide a config.workspaceOID or set environment variable RALLY_WORKSPACE");this.workspaceOID=process.env.RALLY_WORKSPACE}this.username=null!=t.username?t.username:("undefined"!=typeof process&&null!==process?null!=(p=process.env)?p.RALLY_USER:void 0:void 0)?process.env.RALLY_USER:void 0,this.password=null!=t.password?t.password:("undefined"!=typeof process&&null!==process?null!=(f=process.env)?f.RALLY_PASSWORD:void 0:void 0)?process.env.RALLY_PASSWORD:void 0,this.protocol="https",this.server="rally1.rallydev.com",this.service="analytics",this.version="v2.0",this.endpoint="artifact/snapshot/query.js",this._hasMorePages=!0,this._firstPage=!0,this.ETLDate=null,this.lastResponseText="",this.lastResponse={},this.lastPageResults=[],this.allResults=[],this.lastPageMeta={},this.allMeta=[]}return t.prototype.resetFind=function(){return this._find=null},t.prototype.find=function(t){return this._find=t,this},t.prototype.sort=function(){throw Error("Sort must be {_ValidFrom: 1}.")},t.prototype._setSort=function(t){return this._sort=t,this},t.prototype.fields=function(t){return this._fields=this._fields.concat(t),this},t.prototype.hydrate=function(t){return this._hydrate=t,this},t.prototype.start=function(t){return this._startIndex=t,this},t.prototype.startIndex=function(t){return this._startIndex=t,this},t.prototype.pagesize=function(t){return this._pageSize=t,this},t.prototype.pageSize=function(t){return this._pageSize=t,this},t.prototype.auth=function(t,e){return this.username=t,this.password=e,this},t.prototype.debug=function(){return this._debug=!0},t.prototype.getBaseURL=function(){return this.protocol+"://"+[this.server,this.service,this.version,"service/rally/workspace",this.workspaceOID,this.endpoint].join("/")},t.prototype.getQueryString=function(){var t,e;if(t=JSON.stringify(this._find),null!=this._find&&t.length>2)return e=[],e.push("find="+t),null!=this._sort&&e.push("sort="+JSON.stringify(this._sort)),null!=this._fields&&(this._fields[0]===!0?e.push("fields=true"):this._fields.length>0&&e.push("fields="+JSON.stringify(this._fields))),null!=this._hydrate&&e.push("hydrate="+JSON.stringify(this._hydrate)),e.push("start="+this._startIndex),e.push("pagesize="+this._pageSize),e.join("&");throw Error("find clause not set")},t.prototype.getURL=function(){var t;return t=this.getBaseURL()+"?"+this.getQueryString(),this._debug&&(console.log("\nfind: ",this._find),console.log("\nurl:"),console.log(t)),encodeURI(t)},t.prototype.getAll=function(){throw Error("getAll() not supported in this version of AnalyticsQuery.")},t.prototype.hasMorePages=function(){return this._hasMorePages},t.prototype.getPage=function(t){var e,r,i;if(this._callback=t,null==this._find)throw Error("Must set find clause before calling getPage");if(null==this.XHRClass)throw Error("Must set XHRClass");if(!this._hasMorePages)throw Error("All pages retrieved. Inspect AnalyticsQuery.allResults and AnalyticsQuery.allMeta for results.");if(null==this.upToDate)throw Error("Must set property upToDate before calling getPage");this._xhr=new this.XHRClass,this._xhr.onreadystatechange=this._gotResponse,this._xhr.open("GET",this.getURL(),!0,this.username,this.password),i=this.headers;for(e in i)r=i[e],this._xhr.setRequestHeader(e,r);return this._xhr.send(),this},t.prototype._gotResponse=function(){var t,e,r,i,s,o,n,a,l,h;if(this._debug&&console.log("\nreadyState: ",this._xhr.readyState),4===this._xhr.readyState){if(this.lastResponseText=this._xhr.responseText,this.lastResponse=JSON.parse(this.lastResponseText),this._debug&&(console.log("\nresponse headers:\n"),console.log(this._xhr.getAllResponseHeaders()),console.log("\nstatus: ",this._xhr.status),"string"==typeof this.lastResponse?console.log("\nlastResponseText: ",this.lastResponseText):console.log("\nlastResponseJSON: ",this.lastResponse)),this.lastResponse.Errors.length>0)return console.log("Errors\n"+JSON.stringify(this.lastResponse.Errors)),_return();if(this._firstPage)this._firstPage=!1,this.allResults=[],this.allMeta=[],this.ETLDate=this.lastResponse.ETLDate,this._pageSize=this.lastResponse.PageSize,r={$and:[this._find,{_ValidFrom:{$lte:this.ETLDate}}]},this._find=r;else if(this.lastResponse.PageSize!==this._pageSize)throw Error("Pagesize changed after first page which is unexpected.");for(this.lastPageResults=[],s=this.lastResponse.Results,a=0,l=s.length;l>a;a++)i=s[a],this.lastPageResults.push(i);this.allResults=this.allResults.concat(this.lastPageResults),this.lastPageMeta={},h=this.lastResponse;for(e in h)n=h[e],"Results"!==e&&(this.lastPageMeta[e]=n);return this.allMeta.push(this.lastPageMeta),this.lastResponse.Results.length+this.lastResponse.StartIndex>=this.lastResponse.TotalResultCount?(this._hasMorePages=!1,t=this.ETLDate):(this._hasMorePages=!0,this._startIndex+=this._pageSize,t=this.lastPageResults[this.lastPageResults.length-1]._ValidFrom),o=this.upToDate,this.upToDate=t,this._callback(this.lastPageResults,o,t,this)}},t}(),s=function(t){function e(t,r){e.__super__.constructor.call(this,t,r),this._scope={},this._type=null,this._additionalCriteria=[]}return c(e,t),e.prototype.generateFind=function(){var t,e,r,i,s,o;if(e=[],!(JSON.stringify(this._scope).length>2))throw Error("Must set scope first.");for(e.push(this._scope),null!=this._type&&e.push(this._type),s=this._additionalCriteria,r=0,i=s.length;i>r;r++)t=s[r],e.push(t);return(o=e.length)>0&&2>o?e[0]:{$and:e}},e.prototype.find=function(){if(arguments.length>0)throw Error("Do not call find() directly to set query. Use scope(), type(), and additionalCriteria()");return e.__super__.find.call(this,this.generateFind()),this},e.prototype.resetScope=function(){return this._scope={}},e.prototype.scope=function(t,e){var r,i,s,o=this;if(r=function(t,e){var r;if("ItemHierarchy"===t&&(t="_ItemHierarchy"),"Tag"===t&&(t="Tags"),"ProjectHierarchy"===t&&(t="_ProjectHierarchy"),r=["Project","_ProjectHierarchy","Iteration","Release","Tags","_ItemHierarchy"],0>p.call(r,t))throw Error("Key for scope() call must be one of "+r);return o._scope[t]="array"===a(e)?{$in:e}:e},"object"===a(t))for(i in t)s=t[i],r(i,s);else{if(2!==arguments.length)throw Error("Must provide an Object in first parameter or two parameters (key, value).");r(t,e)}return this},e.prototype.resetType=function(){return this._type=null},e.prototype.type=function(t){return this._type={_TypeHierarchy:t},this},e.prototype.resetAdditionalCriteria=function(){return this._additionalCriteria=[]},e.prototype.additionalCriteria=function(t){return this._additionalCriteria.push(t),this},e.prototype.leafOnly=function(){return this.additionalCriteria({$or:[{_TypeHierarchy:"HierarchicalRequirement",Children:null},{_TypeHierarchy:"PortfolioItem",Children:null,UserStories:null}]}),this},e.prototype.getPage=function(t){return this.find(),e.__super__.getPage.call(this,t)},e}(t),e=function(t){function e(t,r,i){if(e.__super__.constructor.call(this,t,r),null==i)throw Error("Must provide a zuluDateString when instantiating an AtAnalyticsQuery.");this._additionalCriteria.push({_At:i})}return c(e,t),e}(s),r=function(t){function e(t,r){throw e.__super__.constructor.call(this,t,r),Error("AtArrayAnalyticsQuery is not yet implemented")}return c(e,t),e}(s),i=function(t){function e(t,r,i){var s;if(e.__super__.constructor.call(this,t,r),null==r||null==i)throw Error("Must provide two zulu data strings when instantiating a BetweenAnalyticsQuery.");s={_ValidFrom:{$lt:i},_ValidTo:{$gt:r}},this._additionalCriteria.push(s)}return c(e,t),e}(s),o=function(t){function e(t,r,i){if(e.__super__.constructor.call(this,t,r),null==i)throw Error("Must provide a predicate when instantiating a TimeInStateAnalyticsQuery.");this._additionalCriteria.push(i),this._additionalCriteria.push({_ValidTo:{$gt:r}}),this.fields(["ObjectID","_ValidFrom","_ValidTo"])}return c(e,t),e}(s),n=function(t){function e(t,r){throw e.__super__.constructor.call(this,t,r),Error("Not yet implemented")}return c(e,t),e}(s),l.AnalyticsQuery=t,l.GuidedAnalyticsQuery=s,l.AtAnalyticsQuery=e,l.AtArrayAnalyticsQuery=r,l.BetweenAnalyticsQuery=i,l.TimeInStateAnalyticsQuery=o,l.TransitionsAnalyticsQuery=n}).call(this);
</script> 
        
        <!-- my calculator for this chart -->
        
<script type="text/javascript">
(function(){var t,e,r,i,s,o,n=[].indexOf||function(t){for(var e=0,r=this.length;r>e;e++)if(e in this&&this[e]===t)return e;return-1};i=this,r="undefined"!=typeof exports&&null!==exports?require("../lib/lumenize"):require("/lumenize"),t=r.ChartTime,s=r.timeSeriesCalculator,o=r.utils,e=function(e,i){var s,a,l,u,h,c,p,f,d,y,g,_,m,A,S,R,v,C,w,T,D,P,I,E,O,k,z,b,x,M,L;for(f=null!=i.granularity?i.granularity:"day",P=i.start,"string"===o.type(P)&&(P=new t(P,f,i.workspaceConfiguration.TimeZone)),R=new t(e[e.length-1]._ValidFrom,f,i.workspaceConfiguration.TimeZone).add(1),v={workDays:i.workspaceConfiguration.WorkDays,holidays:i.holidays,start:P,pastEnd:R},null==i.upSeriesType&&(i.upSeriesType="Sums"),h=[],"Points"===i.upSeriesType?h.push({name:"Accepted",f:function(t){var e;return e=t.ScheduleState,n.call(i.acceptedStates,e)>=0?t.PlanEstimate:0}}):"Story Count"===i.upSeriesType?h.push({name:"Accepted",f:function(t){var e;return e=t.ScheduleState,n.call(i.acceptedStates,e)>=0?1:0}}):console.error("Unrecognized upSeriesType: "+i.upSeriesType),D=[],a=[],x=i.series,k=0,b=x.length;b>k;k++){switch(C=x[k],T=!0,C){case"down":A="Task To Do (Hours)",c="$sum",p="TaskRemainingTotal",O=0,E="column";break;case"ideal":A="Ideal (Hours)",c="$sum",p="TaskEstimateTotal",O=0,E="line";break;case"up":A="Accepted ("+i.upSeriesType+")",c="$sum",p="Accepted",O=1,E="column";break;case"scope":A="Scope ("+i.upSeriesType+")","Story Count"===i.upSeriesType?c="$count":"Points"===i.upSeriesType&&(c="$sum"),p="PlanEstimate",O=1,E="line";break;default:null!=C.name&&null!=C.f&&null!=C.field?(A=C.name,c=C.f,p=C.field,E="column"):(T=!1,console.error("Unrecognizable series: "+C))}T&&(a.push({name:A,as:A,f:c,field:p,yAxis:O,type:E}),D.push(A))}if(I={rangeSpec:v,derivedFields:h,aggregationSpec:a,timezone:i.workspaceConfiguration.TimeZone,snapshotValidFromField:"_ValidFrom",snapshotValidToField:"_ValidTo",snapshotUniqueID:"ObjectID"},M=r.timeSeriesCalculator(e,I),_=M.listOfAtCTs,s=M.aggregationAtArray,console.log("aggregationAtArray: "+JSON.stringify(s,null,2)),w=r.aggregationAtArray_To_HighChartsSeries(s,a),l=function(){var t,e,r;for(r=[],t=0,e=_.length;e>t;t++)u=_[t],r.push(""+(""+u));return r}(),S=l.length,n.call(i.series,"ideal")>=0){for(d=0;0>w[d].name.indexOf("Ideal");)d++;for(y=w[d].data,m=r.functions.$max(y),g=m/(S-1),d=z=0,L=S-2;L>=0?L>=z:z>=L;d=L>=0?++z:--z)y[d]=(S-1-d)*g;y[S-1]=0}return{categories:l,series:w}},i.burnCalculator=e}).call(this);
</script> 
                
        <script type="text/javascript">
        
            var lumenize = require('/lumenize');
            lumenize.ChartTime.setTZPath('anything');
            
            $(document).ready(function() {
                            
                // Let's say you have this data. I've put it in this CSV-style format for easy entry and comprehension.
                resultsCSVStyle = [
                    ["ObjectID", "_ValidFrom",           "_ValidTo",             "ScheduleState"  , "PlanEstimate", "TaskRemainingTotal", "TaskEstimateTotal"],
                                                                        
                    [1,          "2010-10-10T15:00:00Z", "2011-01-02T13:00:00Z", "Ready to pull", 5            , 15                     , 15],  // Shouldn't show up, 2010 before start
                    
                    [1,          "2011-01-02T13:00:00Z", "2011-01-02T15:10:00Z", "Ready to pull", 5            , 15                     , 15],  // !TODO: Should get the same results even without this line
                    [1,          "2011-01-02T15:10:00Z", "2011-01-04T15:00:00Z", "In progress"  , 5            , 20                     , 15],  // Testing it starting at one state and switching later to another
                    [2,          "2011-01-02T15:00:00Z", "2011-01-03T15:00:00Z", "Ready to pull", 3            , 5                      , 5],                
                    [3,          "2011-01-02T15:00:00Z", "2011-01-03T15:00:00Z", "Ready to pull", 5            , 12                     , 12], 
                    
                    [2,          "2011-01-03T15:00:00Z", "2011-01-04T15:00:00Z", "In progress"  , 3            , 5                      , 5], 
                    [3,          "2011-01-03T15:00:00Z", "2011-01-04T15:00:00Z", "Ready to pull", 5            , 12                     , 12], 
                    [4,          "2011-01-03T15:00:00Z", "2011-01-04T15:00:00Z", "Ready to pull", 5            , 15                     , 15], 
                    [1,          "2011-01-03T15:10:00Z", "2011-01-04T15:00:00Z", "In progress"  , 5            , 12                     , 15],  // Testing later change
                    
                    [1,          "2011-01-04T15:00:00Z", "2011-01-06T15:00:00Z", "Accepted"     , 5            , 0                      , 15], 
                    [2,          "2011-01-04T15:00:00Z", "2011-01-06T15:00:00Z", "In test"      , 3            , 1                      , 5], 
                    [3,          "2011-01-04T15:00:00Z", "2011-01-05T15:00:00Z", "In progress"  , 5            , 10                     , 12], 
                    [4,          "2011-01-04T15:00:00Z", "2011-01-06T15:00:00Z", "Ready to pull", 5            , 15                     , 15], 
                    [5,          "2011-01-04T15:00:00Z", "2011-01-06T15:00:00Z", "Ready to pull", 2            , 4                      , 4], 
                    
                    [3,          "2011-01-05T15:00:00Z", "2011-01-07T15:00:00Z", "In test"      , 5            , 5                      , 12],
                    
                    [1,          "2011-01-06T15:00:00Z", "2011-01-07T15:00:00Z", "Released"     , 5            , 0                      , 15], 
                    [2,          "2011-01-06T15:00:00Z", "2011-01-07T15:00:00Z", "Accepted"     , 3            , 0                      , 5], 
                    [4,          "2011-01-06T15:00:00Z", "2011-01-07T15:00:00Z", "In progress"  , 5            , 7                      , 15], 
                    [5,          "2011-01-06T15:00:00Z", "2011-01-07T15:00:00Z", "Ready to pull", 2            , 4                      , 4], 
                    
                    [1,          "2011-01-07T15:00:00Z", "9999-01-01T00:00:00Z", "Released"     , 5            , 0                      , 15], 
                    [2,          "2011-01-07T15:00:00Z", "9999-01-01T00:00:00Z", "Released"     , 3            , 0                      , 5], 
                    [3,          "2011-01-07T15:00:00Z", "9999-01-01T00:00:00Z", "Accepted"     , 5            , 0                      , 12], 
                    [4,          "2011-01-07T15:00:00Z", "9999-01-01T00:00:00Z", "In test"      , 5            , 3                      , 15], 
                    [5,          "2011-01-07T15:00:00Z", "9999-01-01T00:00:00Z", "In progress"  , 2            , 4                      , 4]
                ];
                
                // The CSV-style table is not what it would look like from the Rally Analytics API so let's fix that.
                var results = lumenize.csvStyleArray_To_ArrayOfMaps(resultsCSVStyle);
                
                // Replace above code with call to LookbackAPI
                // For PI/Story burn chart, {_ItemHiearchy: 123456L} where 123456L is the ObjectID of the PI or Story
                
                var workspaceConfiguration = {  // Need to grab from Rally for this user
                  DateFormat: 'MM/dd/yyyy',
                  DateTimeFormat: 'MM/dd/yyyy hh:mm:ss a',
                  IterationEstimateUnitName: 'Points',  // !TODO: Should we use this?
                  ReleaseEstimateUnitName: 'Points',
                  TaskUnitName: 'Hours',
                  TimeTrackerEnabled: true,
                  TimeZone: 'America/Denver',
                  WorkDays: 'Sunday,Monday,Tuesday,Wednesday,Thursday,Friday' // They work on Sundays
                };
                
                var config = {
                  workspaceConfiguration: workspaceConfiguration,
                  upSeriesType: 'Points', // 'Points' or 'Story Count'
                  series: [
                    'down',
                    'up',
                    'projectionToCurrentScope',
                    'projectionToProjectedScope',
                    'ideal',
                    'scope'
                  ],
                  acceptedStates: ['Accepted', 'Released'],
                  start: "2011-01-02T13:00:00Z",  // Calculated either by inspecting results or via configuration. pastEnd is automatically the last date in results
                  holidays: [
                    {month: 12, day: 25}, // Notice how the year can be omitted
                    {year: 2011, month: 11, day: 26},
                    {year: 2011, month: 1, day: 5}  // Made up holiday to demo holiday knockout
                  ]
                };
                                
                var tscResults = burnCalculator(results, config);
                
                var categories = tscResults.categories;
                var series = tscResults.series;
                
                chart = new Highcharts.Chart({
                    chart: {
                        renderTo: 'container',
                        defaultSeriesType: 'column'
                    },
                    credits: {
                        enabled: false
                    },
                    title: {
                        text: 'Burn Chart'
                    },
                    subtitle: {
                        text: ''
                    },
                    xAxis: {
                        categories: categories,
                        tickmarkPlacement: 'on',
                        tickInterval: Math.floor(categories.length / 13) + 1,
                        title: {
                            enabled: false
                        }
                    },
                    yAxis: [
                        {
                            title: {
                                text: 'Hours'
                            },
                            labels: {
                                formatter: function() {
                                    return this.value / 1;
                                }
                            },
                            min: 0
                        },
                        {
                            title: {
                                text: config.upSeriesType
                            },
                            opposite: true,
                            labels: {
                                formatter: function() {
                                    return this.value / 1;
                                }
                            },
                            min: 0
                        }                        
                    ],
                    tooltip: {
                        formatter: function() {
                            return ''+ this.x + '<br />' + this.series.name + ': ' + this.y;
                        }
                    },
                    plotOptions: {
                        column: {
                            stacking: null,
                            lineColor: '#666666',
                            lineWidth: 1,
                            marker: {
                                lineWidth: 1,
                                lineColor: '#666666'
                            }
                        },
/*
                        series: {
                            allowPointSelect: true,
                            point: {
                                events: {
                                    select: function(event) {
                                        // Use this to highlight the rows in a table
                                        alert('ObjectIDs: ' +
                                            JSON.stringify(cfdCalculation.drillDownObjectIDs[this.series.name][this.x]));
                                    },
                                    unselect: function(event) {
                                        alert('Unselect rows')
                                    }
                                }
                            }
                        }
*/
                    },
                    series: series
                });
                      
                                  
                
            });
                
        </script>
        
    </head>
    <body>
        
        <!-- 3. Add the container -->
        <div id="container" style="width: 75%; height: 75%; margin: 0 auto"></div>
        
    </body>
</html>
