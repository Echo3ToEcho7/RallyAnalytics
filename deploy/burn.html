<!DOCTYPE HTML>
<html>
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
        <title>Rally Burn Chart Prototype</title>
        
        <!-- HighCharts -->
        <script type="text/javascript" src="https://people.rallydev.com/js/jquery.min.js"></script>
        <script type="text/javascript" src="https://people.rallydev.com/js/highcharts.js"></script>
        <script type="text/javascript" src="https://people.rallydev.com/js/exporting.js"></script>
        <!-- a theme file
            <script type="text/javascript" src="../js/themes/gray.js"></script>
        -->
        
        <!-- Lumenize -->
        <script type="text/javascript" src="https://raw.github.com/lmaccherone/Lumenize/v0.4.3/deploy/Lumenize.js"></script>
        
        <!-- rally_analytics -->
        
<script type="text/javascript">
(function(){var t,e,i,s,r,n,o,a,l,h,u,c=function(t,e){return function(){return t.apply(e,arguments)}},p={}.hasOwnProperty,d=function(t,e){function i(){this.constructor=t}for(var s in e)p.call(e,s)&&(t[s]=e[s]);return i.prototype=e.prototype,t.prototype=new i,t.__super__=e.prototype,t},f=[].indexOf||function(t){for(var e=0,i=this.length;i>e;e++)if(e in this&&this[e]===t)return e;return-1};l="undefined"!=typeof exports&&null!==exports?require("../lib/Lumenize"):require("/lumenize"),u=l.utils,n=l.Time,h=this,t=function(){function t(t,e){var i,s,r,n,o,a,l,u,p,d;this.upToDate=e,this._gotResponse=c(this._gotResponse,this),this._debug=!1,"undefined"==typeof process||null===process||"undefined"!=typeof window&&null!==window?null!=h.XMLHttpRequest&&(i=h.XMLHttpRequest):i=require("xmlhttprequest").XMLHttpRequest,this.XHRClass=i,this._xhr=null,this._find=null,this._fields=[],this._sort={_ValidFrom:1},this._startIndex=0,this._pageSize=1e7,this._callback=null,this.headers={},this.headers["X-RallyIntegrationLibrary"]="rally_analytics-0.1.0","undefined"!=typeof navigator&&null!==navigator?(o=navigator.appName+" "+navigator.appVersion,n=navigator.platform):"undefined"!=typeof process&&null!==process&&(o="Node.js (or some other non-browser) "+process.version,n=process.platform),this.headers["X-RallyIntegrationPlatform"]=o,this.headers["X-RallyIntegrationOS"]=n,l=t.additionalHeaders;for(r in l)a=l[r],this.headers[r]=a;if(s=function(e,i){if(null!=t[i])return e[i]=t[i];throw Error("Must include config["+i+"] header when instantiating this rally_analytics.AnalyticsQuery object")},s(this.headers,"X-RallyIntegrationName"),s(this.headers,"X-RallyIntegrationVendor"),s(this.headers,"X-RallyIntegrationVersion"),null!=t.workspaceOID)this.workspaceOID=t.workspaceOID;else{if(!("undefined"!=typeof process&&null!==process?null!=(u=process.env)?u.RALLY_WORKSPACE:void 0:void 0))throw Error("Must provide a config.workspaceOID or set environment variable RALLY_WORKSPACE");this.workspaceOID=process.env.RALLY_WORKSPACE}this.username=null!=t.username?t.username:("undefined"!=typeof process&&null!==process?null!=(p=process.env)?p.RALLY_USER:void 0:void 0)?process.env.RALLY_USER:void 0,this.password=null!=t.password?t.password:("undefined"!=typeof process&&null!==process?null!=(d=process.env)?d.RALLY_PASSWORD:void 0:void 0)?process.env.RALLY_PASSWORD:void 0,this.protocol="https",this.server="rally1.rallydev.com",this.service="analytics",this.version="v2.0",this.endpoint="artifact/snapshot/query.js",this.virgin=!0,this._hasMorePages=!0,this._firstPage=!0,this.ETLDate=null,this.lastResponseText="",this.lastResponse={},this.lastPageResults=[],this.allResults=[],this.lastPageMeta={},this.allMeta=[]}return t.prototype.resetFind=function(){return this._find=null},t.prototype.find=function(t){return this._find=t,this},t.prototype.sort=function(){throw Error("Sort must be {_ValidFrom: 1}.")},t.prototype._setSort=function(t){return this._sort=t,this},t.prototype.fields=function(t){return this._fields=this._fields.concat(t),this},t.prototype.hydrate=function(t){return this._hydrate=t,this},t.prototype.start=function(t){return this._startIndex=t,this},t.prototype.startIndex=function(t){return this._startIndex=t,this},t.prototype.pagesize=function(t){return this._pageSize=t,this},t.prototype.pageSize=function(t){return this._pageSize=t,this},t.prototype.auth=function(t,e){return this.username=t,this.password=e,this},t.prototype.debug=function(){return this._debug=!0},t.prototype.getBaseURL=function(){return this.protocol+"://"+[this.server,this.service,this.version,"service/rally/workspace",this.workspaceOID,this.endpoint].join("/")},t.prototype.getQueryString=function(){var t,e;if(t=JSON.stringify(this._find),null!=this._find&&t.length>2)return e=[],e.push("find="+t),null!=this._sort&&e.push("sort="+JSON.stringify(this._sort)),null!=this._fields&&(this._fields[0]===!0?e.push("fields=true"):this._fields.length>0&&e.push("fields="+JSON.stringify(this._fields))),null!=this._hydrate&&e.push("hydrate="+JSON.stringify(this._hydrate)),e.push("start="+this._startIndex),e.push("pagesize="+this._pageSize),e.join("&");throw Error("find clause not set")},t.prototype.getURL=function(){var t;return t=this.getBaseURL()+"?"+this.getQueryString(),this._debug&&(console.log("\nfind: ",this._find),console.log("\nurl:"),console.log(t)),encodeURI(t)},t.prototype.getAll=function(t){return this.virgin&&(this.allCallback=t,this.virgin=!1,this.upToDate="2011-12-01T00:00:00.000Z"),this.hasMorePages()?this.getPage(this.getAll):this.allCallback.call(this)},t.prototype.hasMorePages=function(){return this._hasMorePages},t.prototype.getPage=function(t){var e,i,s;if(this._callback=t,null==this._find)throw Error("Must set find clause before calling getPage");if(null==this.XHRClass)throw Error("Must set XHRClass");if(!this._hasMorePages)throw Error("All pages retrieved. Inspect AnalyticsQuery.allResults and AnalyticsQuery.allMeta for results.");if(null==this.upToDate)throw Error("Must set property upToDate before calling getPage");this._xhr=new this.XHRClass,this._xhr.onreadystatechange=this._gotResponse,this._xhr.open("GET",this.getURL(),!0,this.username,this.password),s=this.headers;for(e in s)i=s[e],this._xhr.setRequestHeader(e,i);return this._xhr.send(),this},t.prototype._gotResponse=function(){var t,e,i,s,r,n,o,a,l;if(this._debug&&console.log("\nreadyState: ",this._xhr.readyState),4===this._xhr.readyState){if(this.lastResponseText=this._xhr.responseText,this.lastResponse=JSON.parse(this.lastResponseText),this._debug&&(console.log("\nresponse headers:\n"),console.log(this._xhr.getAllResponseHeaders()),console.log("\nstatus: ",this._xhr.status),"string"==typeof this.lastResponse?console.log("\nlastResponseText: ",this.lastResponseText):console.log("\nlastResponseJSON: ",this.lastResponse)),this.lastResponse.Errors.length>0)return console.log("Errors\n"+JSON.stringify(this.lastResponse.Errors)),_return();if(this._firstPage)this._firstPage=!1,this.allResults=[],this.allMeta=[],this.ETLDate=this.lastResponse.ETLDate,this._pageSize=this.lastResponse.PageSize,e={$and:[this._find,{_ValidFrom:{$lte:this.ETLDate}}]},this._find=e;else if(this.lastResponse.PageSize!==this._pageSize)throw Error("Pagesize changed after first page which is unexpected.");for(r=this.upToDate,this.lastResponse.Results.length+this.lastResponse.StartIndex>=this.lastResponse.TotalResultCount?(this._hasMorePages=!1,this.upToDate=this.ETLDate):(this._hasMorePages=!0,this.upToDate=this.lastResponse.Results[this.lastResponse.Results.length-1]._ValidFrom),this.lastPageResults=[],s=this.lastResponse.Results,o=0,a=s.length;a>o;o++)i=s[o],i._ValidFrom!==this.upToDate&&this.lastPageResults.push(i);this._startIndex+=this.lastPageResults.length,this.allResults=this.allResults.concat(this.lastPageResults),this.lastPageMeta={},l=this.lastResponse;for(t in l)n=l[t],"Results"!==t&&(this.lastPageMeta[t]=n);return this.allMeta.push(this.lastPageMeta),this._callback(this.lastPageResults,r,this.upToDate,this)}},t}(),r=function(t){function e(t,i){e.__super__.constructor.call(this,t,i),this._scope={},this._type=null,this._additionalCriteria=[]}return d(e,t),e.prototype.generateFind=function(){var t,e,i,s,r,n;if(e=[],!(JSON.stringify(this._scope).length>2))throw Error("Must set scope first.");for(e.push(this._scope),null!=this._type&&e.push(this._type),r=this._additionalCriteria,i=0,s=r.length;s>i;i++)t=r[i],e.push(t);return(n=e.length)>0&&2>n?e[0]:{$and:e}},e.prototype.find=function(){if(arguments.length>0)throw Error("Do not call find() directly to set query. Use scope(), type(), and additionalCriteria()");return e.__super__.find.call(this,this.generateFind()),this},e.prototype.resetScope=function(){return this._scope={}},e.prototype.scope=function(t,e){var i,s,r,n=this;if(i=function(t,e){var i;if("ItemHierarchy"===t&&(t="_ItemHierarchy"),"Tag"===t&&(t="Tags"),"ProjectHierarchy"===t&&(t="_ProjectHierarchy"),i=["Project","_ProjectHierarchy","Iteration","Release","Tags","_ItemHierarchy"],0>f.call(i,t))throw Error("Key for scope() call must be one of "+i);return n._scope[t]="array"===u.type(e)?{$in:e}:e},"object"===u.type(t))for(s in t)r=t[s],i(s,r);else{if(2!==arguments.length)throw Error("Must provide an Object in first parameter or two parameters (key, value).");i(t,e)}return this},e.prototype.resetType=function(){return this._type=null},e.prototype.type=function(t){return this._type={_TypeHierarchy:t},this},e.prototype.resetAdditionalCriteria=function(){return this._additionalCriteria=[]},e.prototype.additionalCriteria=function(t){return this._additionalCriteria.push(t),this},e.prototype.leafOnly=function(){return this.additionalCriteria({$or:[{_TypeHierarchy:-51038,Children:null},{_TypeHierarchy:-51078,Children:null,UserStories:null},{_TypeHierarchy:{$nin:[-51038,-51078]}}]}),this},e.prototype.getPage=function(t){return this.find(),e.__super__.getPage.call(this,t)},e}(t),e=function(t){function e(t,i,s){if(e.__super__.constructor.call(this,t,i),null==s)throw Error("Must provide a zuluDateString when instantiating an AtAnalyticsQuery.");this._additionalCriteria.push({_At:s})}return d(e,t),e}(r),i=function(t){function e(t,i){throw e.__super__.constructor.call(this,t,i),Error("AtArrayAnalyticsQuery is not yet implemented")}return d(e,t),e}(r),s=function(t){function e(t,i,s){var r;if(e.__super__.constructor.call(this,t,i),null==i||null==s)throw Error("Must provide two zulu data strings when instantiating a BetweenAnalyticsQuery.");r={_ValidFrom:{$lt:s},_ValidTo:{$gt:i}},this._additionalCriteria.push(r)}return d(e,t),e}(r),o=function(t){function e(t,i,s){if(e.__super__.constructor.call(this,t,i),null==s)throw Error("Must provide a predicate when instantiating a TimeInStateAnalyticsQuery.");this._additionalCriteria.push(s),this._additionalCriteria.push({_ValidTo:{$gt:i}}),this.fields(["ObjectID","_ValidFrom","_ValidTo"])}return d(e,t),e}(r),a=function(t){function e(t,i,s){if(e.__super__.constructor.call(this,t,i),null==s)throw Error("Must provide a predicate when instantiating a TimeInStateAnalyticsQuery.");this._additionalCriteria.push(s),this._additionalCriteria.push({_ValidFrom:{$gte:i}}),this.fields(["ObjectID","_ValidFrom","_ValidTo"])}return d(e,t),e}(r),h.AnalyticsQuery=t,h.GuidedAnalyticsQuery=r,h.AtAnalyticsQuery=e,h.AtArrayAnalyticsQuery=i,h.BetweenAnalyticsQuery=s,h.TimeInStateAnalyticsQuery=o,h.TransitionsAnalyticsQuery=a}).call(this);
</script> 
        
        <!-- my calculator for this chart -->
        
<script type="text/javascript">
(function(){var t,e,i,s,r,n,o=[].indexOf||function(t){for(var e=0,i=this.length;i>e;e++)if(e in this&&this[e]===t)return e;return-1};s=this,i="undefined"!=typeof exports&&null!==exports?require("../lib/lumenize"):require("/lumenize"),t=i.ChartTime,r=i.timeSeriesCalculator,n=i.utils,e=function(e,s){var r,a,l,h,u,c,p,d,f,g,y,_,m,S,v,R,A,w,T,C,I,P,D,O,z,E,b,k,x,M,V;for(d=null!=s.granularity?s.granularity:"day",P=s.start,"string"===n.type(P)&&(P=new t(P,d,s.workspaceConfiguration.TimeZone)),R=new t(e[e.length-1]._ValidFrom,d,s.workspaceConfiguration.TimeZone).add(1),A={workDays:s.workspaceConfiguration.WorkDays,holidays:s.holidays,start:P,pastEnd:R},null==s.upSeriesType&&(s.upSeriesType="Sums"),u=[],"Points"===s.upSeriesType?u.push({name:"Accepted",f:function(t){var e;return e=t.ScheduleState,o.call(s.acceptedStates,e)>=0?t.PlanEstimate:0}}):"Story Count"===s.upSeriesType?u.push({name:"Accepted",f:function(t){var e;return e=t.ScheduleState,o.call(s.acceptedStates,e)>=0?1:0}}):console.error("Unrecognized upSeriesType: "+s.upSeriesType),I=[],a=[],x=s.series,E=0,k=x.length;k>E;E++){switch(w=x[E],C=!0,w){case"down":S="Task To Do (Hours)",c="$sum",p="TaskRemainingTotal",z=0,O="column";break;case"ideal":S="Ideal (Hours)",c="$sum",p="TaskEstimateTotal",z=0,O="line";break;case"up":S="Accepted ("+s.upSeriesType+")",c="$sum",p="Accepted",z=1,O="column";break;case"scope":S="Scope ("+s.upSeriesType+")","Story Count"===s.upSeriesType?c="$count":"Points"===s.upSeriesType&&(c="$sum"),p="PlanEstimate",z=1,O="line";break;default:null!=w.name&&null!=w.f&&null!=w.field?(S=w.name,c=w.f,p=w.field,O="column"):(C=!1,console.error("Unrecognizable series: "+w))}C&&(a.push({name:S,as:S,f:c,field:p,yAxis:z,type:O}),I.push(S))}if(D={rangeSpec:A,derivedFields:u,aggregationSpec:a,timezone:s.workspaceConfiguration.TimeZone,snapshotValidFromField:"_ValidFrom",snapshotValidToField:"_ValidTo",snapshotUniqueID:"ObjectID"},M=i.timeSeriesCalculator(e,D),_=M.listOfAtCTs,r=M.aggregationAtArray,console.log("aggregationAtArray: "+JSON.stringify(r,null,2)),T=i.aggregationAtArray_To_HighChartsSeries(r,a),l=function(){var t,e,i;for(i=[],t=0,e=_.length;e>t;t++)h=_[t],i.push(""+(""+h));return i}(),v=l.length,o.call(s.series,"ideal")>=0){for(f=0;0>T[f].name.indexOf("Ideal");)f++;for(g=T[f].data,m=i.functions.$max(g),y=m/(v-1),f=b=0,V=v-2;V>=0?V>=b:b>=V;f=V>=0?++b:--b)g[f]=(v-1-f)*y;g[v-1]=0}return{categories:l,series:T}},s.burnCalculator=e}).call(this);
</script> 
                
        <script type="text/javascript">
        
            var lumenize = require('/lumenize');
            
            $(document).ready(function() {
                            
                // Let's say you have this data. I've put it in this CSV-style format for easy entry and comprehension.
                resultsCSVStyle = [
                    ["ObjectID", "_ValidFrom",           "_ValidTo",             "ScheduleState"  , "PlanEstimate", "TaskRemainingTotal", "TaskEstimateTotal"],
                                                                        
                    [1,          "2010-10-10T15:00:00Z", "2011-01-02T13:00:00Z", "Ready to pull", 5            , 15                     , 15],  // Shouldn't show up, 2010 before start
                    
                    [1,          "2011-01-02T13:00:00Z", "2011-01-02T15:10:00Z", "Ready to pull", 5            , 15                     , 15],  // !TODO: Should get the same results even without this line
                    [1,          "2011-01-02T15:10:00Z", "2011-01-04T15:00:00Z", "In progress"  , 5            , 20                     , 15],  // Testing it starting at one state and switching later to another
                    [2,          "2011-01-02T15:00:00Z", "2011-01-03T15:00:00Z", "Ready to pull", 3            , 5                      , 5],                
                    [3,          "2011-01-02T15:00:00Z", "2011-01-03T15:00:00Z", "Ready to pull", 5            , 12                     , 12], 
                    
                    [2,          "2011-01-03T15:00:00Z", "2011-01-04T15:00:00Z", "In progress"  , 3            , 5                      , 5], 
                    [3,          "2011-01-03T15:00:00Z", "2011-01-04T15:00:00Z", "Ready to pull", 5            , 12                     , 12], 
                    [4,          "2011-01-03T15:00:00Z", "2011-01-04T15:00:00Z", "Ready to pull", 5            , 15                     , 15], 
                    [1,          "2011-01-03T15:10:00Z", "2011-01-04T15:00:00Z", "In progress"  , 5            , 12                     , 15],  // Testing later change
                    
                    [1,          "2011-01-04T15:00:00Z", "2011-01-06T15:00:00Z", "Accepted"     , 5            , 0                      , 15], 
                    [2,          "2011-01-04T15:00:00Z", "2011-01-06T15:00:00Z", "In test"      , 3            , 1                      , 5], 
                    [3,          "2011-01-04T15:00:00Z", "2011-01-05T15:00:00Z", "In progress"  , 5            , 10                     , 12], 
                    [4,          "2011-01-04T15:00:00Z", "2011-01-06T15:00:00Z", "Ready to pull", 5            , 15                     , 15], 
                    [5,          "2011-01-04T15:00:00Z", "2011-01-06T15:00:00Z", "Ready to pull", 2            , 4                      , 4], 
                    
                    [3,          "2011-01-05T15:00:00Z", "2011-01-07T15:00:00Z", "In test"      , 5            , 5                      , 12],
                    
                    [1,          "2011-01-06T15:00:00Z", "2011-01-07T15:00:00Z", "Released"     , 5            , 0                      , 15], 
                    [2,          "2011-01-06T15:00:00Z", "2011-01-07T15:00:00Z", "Accepted"     , 3            , 0                      , 5], 
                    [4,          "2011-01-06T15:00:00Z", "2011-01-07T15:00:00Z", "In progress"  , 5            , 7                      , 15], 
                    [5,          "2011-01-06T15:00:00Z", "2011-01-07T15:00:00Z", "Ready to pull", 2            , 4                      , 4], 
                    
                    [1,          "2011-01-07T15:00:00Z", "9999-01-01T00:00:00Z", "Released"     , 5            , 0                      , 15], 
                    [2,          "2011-01-07T15:00:00Z", "9999-01-01T00:00:00Z", "Released"     , 3            , 0                      , 5], 
                    [3,          "2011-01-07T15:00:00Z", "9999-01-01T00:00:00Z", "Accepted"     , 5            , 0                      , 12], 
                    [4,          "2011-01-07T15:00:00Z", "9999-01-01T00:00:00Z", "In test"      , 5            , 3                      , 15], 
                    [5,          "2011-01-07T15:00:00Z", "9999-01-01T00:00:00Z", "In progress"  , 2            , 4                      , 4]
                ];
                
                // The CSV-style table is not what it would look like from the Rally Analytics API so let's fix that.
                var results = lumenize.csvStyleArray_To_ArrayOfMaps(resultsCSVStyle);
                
                // Replace above code with call to LookbackAPI
                // For PI/Story burn chart, {_ItemHiearchy: 123456L} where 123456L is the ObjectID of the PI or Story
                
                var workspaceConfiguration = {  // Need to grab from Rally for this user
                  DateFormat: 'MM/dd/yyyy',
                  DateTimeFormat: 'MM/dd/yyyy hh:mm:ss a',
                  IterationEstimateUnitName: 'Points',  // !TODO: Should we use this?
                  ReleaseEstimateUnitName: 'Points',
                  TaskUnitName: 'Hours',
                  TimeTrackerEnabled: true,
                  TimeZone: 'America/Denver',
                  WorkDays: 'Sunday,Monday,Tuesday,Wednesday,Thursday,Friday' // They work on Sundays
                };
                
                var config = {
                  workspaceConfiguration: workspaceConfiguration,
                  upSeriesType: 'Story Count', // 'Points' or 'Story Count'
                  series: [
                    'down',
                    'up',
/*
                    'projectionToCurrentScope',
                    'projectionToProjectedScope',
*/
                    'ideal',
                    'scope'
                  ],
                  acceptedStates: ['Accepted', 'Released'],
                  start: "2011-01-03T13:00:00Z",  // Calculated either by inspecting results or via configuration. pastEnd is automatically the last date in results
                  holidays: [
                    {month: 12, day: 25}, // Notice how the year can be omitted
                    {year: 2011, month: 11, day: 26},
                    {year: 2011, month: 1, day: 5}  // Made up holiday to demo holiday knockout
                  ]
                };
                                
                var tscResults = burnCalculator(results, config);
                
                var categories = tscResults.categories;
                var series = tscResults.series;
                
                chart = new Highcharts.Chart({
                    chart: {
                        renderTo: 'container',
                        defaultSeriesType: 'column'
                    },
                    credits: {
                        enabled: false
                    },
                    title: {
                        text: 'Burn Chart'
                    },
                    subtitle: {
                        text: ''
                    },
                    xAxis: {
                        categories: categories,
                        tickmarkPlacement: 'on',
                        tickInterval: Math.floor(categories.length / 13) + 1,
                        title: {
                            enabled: false
                        }
                    },
                    yAxis: [
                        {
                            title: {
                                text: 'Hours'
                            },
                            labels: {
                                formatter: function() {
                                    return this.value / 1;
                                }
                            },
                            min: 0
                        },
                        {
                            title: {
                                text: config.upSeriesType
                            },
                            opposite: true,
                            labels: {
                                formatter: function() {
                                    return this.value / 1;
                                }
                            },
                            min: 0
                        }                        
                    ],
                    tooltip: {
                        formatter: function() {
                            return ''+ this.x + '<br />' + this.series.name + ': ' + this.y;
                        }
                    },
                    plotOptions: {
                        column: {
                            stacking: null,
                            lineColor: '#666666',
                            lineWidth: 1,
                            marker: {
                                lineWidth: 1,
                                lineColor: '#666666'
                            }
                        },
/*
                        series: {
                            allowPointSelect: true,
                            point: {
                                events: {
                                    select: function(event) {
                                        // Use this to highlight the rows in a table
                                        alert('ObjectIDs: ' +
                                            JSON.stringify(cfdCalculation.drillDownObjectIDs[this.series.name][this.x]));
                                    },
                                    unselect: function(event) {
                                        alert('Unselect rows')
                                    }
                                }
                            }
                        }
*/
                    },
                    series: series
                });
                      
                                  
                
            });
                
        </script>
        
    </head>
    <body>
        
        <!-- 3. Add the container -->
        <div id="container" style="width: 75%; height: 75%; margin: 0 auto"></div>
        
    </body>
</html>
